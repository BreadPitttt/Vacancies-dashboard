<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>General Vacancy Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta http-equiv="Cache-Control" content="no-store" />
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <header class="topbar">
    <div class="brand">
      <h1>General Vacancy Dashboard</h1>
      <div class="meta">
        <span id="health-pill" class="pill">Health: Unknown</span>
        <span id="last-updated" class="muted">Last updated: —</span>
        <span id="total-listings" class="muted">Listings: —</span>
      </div>
    </div>
    <div class="actions">
      <button id="btn-missing" class="btn ghost" type="button">Submit missing</button>
    </div>
  </header>

  <main class="container">
    <section>
      <h2 class="section-title">Open vacancies</h2>
      <div id="jobs-root" class="cards-grid"></div>
    </section>

    <section>
      <h2 class="section-title">Applied (always visible)</h2>
      <div id="applied-root" class="cards-grid"></div>
    </section>

    <section>
      <h2 class="section-title">Other (past date / not interested)</h2>
      <div id="other-root" class="cards-grid"></div>
    </section>
  </main>

  <!-- Missing modal -->
  <div id="missing-modal" class="modal hidden" aria-hidden="true">
    <div class="modal-body">
      <div class="modal-head">
        <h3>Submit Missing Vacancy</h3>
        <button type="button" class="icon-btn" data-close>&times;</button>
      </div>
      <form id="missingForm" class="form">
        <label>Post name</label>
        <input id="missingTitle" placeholder="e.g., BSSC 4th Graduate Level 2025" required />
        <label>Notification link (official)</label>
        <input id="missingUrl" placeholder="https://...gov.in/..." required />
        <label>Last date (DD-MM-YYYY or N/A)</label>
        <input id="missingLastDate" placeholder="27-10-2025 or N/A" />
        <label>Note (optional)</label>
        <textarea id="missingNote" rows="3" placeholder="Any extra info"></textarea>
        <div class="row end">
          <button type="button" class="btn ghost" data-close>Close</button>
          <button type="submit" class="btn primary">Submit</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Report modal (compact) -->
  <div id="report-modal" class="modal hidden" aria-hidden="true">
    <div class="modal-body">
      <div class="modal-head">
        <h3>Report listing</h3>
        <button type="button" class="icon-btn" data-close>&times;</button>
      </div>
      <form id="reportForm" class="form">
        <input type="hidden" id="reportListingId" />
        <label>Reason</label>
        <select id="reportReason" class="select">
          <option value="" disabled selected>Select reason…</option>
          <option value="not_vacancy">Not a vacancy (result/admit/exam date)</option>
          <option value="last_date_over">Last date over</option>
          <option value="wrong_last_date">Wrong last date</option>
          <option value="wrong_eligibility">Wrong eligibility</option>
          <option value="wrong_domicile">Wrong domicile</option>
          <option value="duplicate">Duplicate / Already listed</option>
          <option value="bad_link">Broken / Unofficial link</option>
          <option value="other">Other</option>
        </select>

        <div class="grid2">
          <div>
            <label>Evidence URL (optional)</label>
            <input id="reportEvidenceUrl" placeholder="https://...gov.in/..." />
          </div>
          <div>
            <label>Note (optional)</label>
            <input id="reportNote" placeholder="Tell more if needed" />
          </div>
        </div>

        <div class="row end gap">
          <button type="button" class="btn ghost" data-close>Close</button>
          <button type="submit" class="btn danger">Report</button>
        </div>
      </form>
    </div>
  </div>

  <script>
    (function(){
      var ENDPOINT = "https://vacancy.animeshkumar97.workers.dev";
      var bust = function(){ return "?t=" + Date.now(); };

      function qs(s, r){ return (r||document).querySelector(s); }
      function esc(s){ return (s==null? "": String(s)).replace(/[&<>\"']/g, function(c){ return {"&":"&amp;","<":"&lt;","&gt;":"&gt;","\"":"&quot;","'":""}[c]; }); }
      function fmtDate(s){ return s && s.toUpperCase()!=="N/A" ? s : "N/A"; }

      function openModal(id){ var m=qs(id); if(m){ m.classList.remove("hidden"); m.setAttribute("aria-hidden","false"); } }
      function closeModal(el){ var m=el.closest(".modal"); if(m){ m.classList.add("hidden"); m.setAttribute("aria-hidden","true"); } }

      async function postJSON(payload){
        try{
          var res = await fetch(ENDPOINT, { method:"POST", headers:{ "Content-Type":"application/json" }, body: JSON.stringify(payload) });
          return res.ok;
        }catch(e){ return false; }
      }

      async function renderStatus(){
        var pill=qs("#health-pill"), last=qs("#last-updated"), total=qs("#total-listings");
        try{
          var h=await (await fetch("health.json"+bust(),{cache:"no-store"})).json();
          pill.textContent=h.ok?"Health: OK":"Health: Not OK"; pill.className="pill "+(h.ok?"ok":"bad");
          var ts=h.lastUpdated||""; last.textContent="Last updated: "+(ts?new Date(ts).toLocaleString():"—");
          total.textContent="Listings: "+(typeof h.totalListings==="number"?h.totalListings:"—");
        }catch(e){
          pill.textContent="Health: Unknown"; pill.className="pill";
          last.textContent="Last updated: —"; total.textContent="Listings: —";
        }
      }

      // Local click-lock states to avoid accidental double submissions before the next run
      var clickState = new Map(); // jobId -> {right:true|false, wrong:true|false, applied:true|false, noti:true|false}

      function setLocked(btn, label){
        btn.textContent = label;
        btn.classList.add("disabled");
        btn.setAttribute("aria-disabled","true");
      }
      function addUndo(container, onUndo){
        var u = document.createElement("button");
        u.className = "btn ghost tiny";
        u.textContent = "Undo";
        u.addEventListener("click", function(e){ e.stopPropagation(); e.preventDefault(); onUndo(); u.remove(); });
        container.appendChild(u);
      }

      function cardHTML(j){
        var b=j.flags&&j.flags.trusted, chip=b?'<span class="chip ok">✓ trusted</span>':"";
        var d=j.daysLeft!=null?j.daysLeft:"—";
        var det=esc(j.detailLink||j.applyLink||"#");
        return '<article class="card" data-id="'+esc(j.id||"")+'">'+
          '<header class="card-head"><h3 class="title">'+esc(j.title||"No Title")+'</h3>'+chip+'</header>'+
          '<div class="card-body">'+
            '<div class="rowline"><span class="muted">Organization</span><span>'+esc(j.organization||"N/A")+'</span></div>'+
            '<div class="rowline"><span class="muted">Qualification</span><span>'+esc(j.qualificationLevel||"N/A")+'</span></div>'+
            '<div class="rowline"><span class="muted">Domicile</span><span>'+esc(j.domicile||"All India")+'</span></div>'+
            '<div class="rowline"><span class="muted">Last date</span><span>'+esc(fmtDate(j.deadline))+' <span class="muted">('+d+' days)</span></span></div>'+
          '</div>'+
          '<footer class="card-actions">'+
            '<a class="btn primary" href="'+det+'" target="_blank" rel="noopener">Details</a>'+
            '<span class="spacer"></span>'+
            '<button class="btn ok" data-act="right">Right</button>'+
            '<button class="btn warn" data-act="wrong">Wrong</button>'+
            '<button class="btn" data-act="applied">Applied</button>'+
            '<button class="btn" data-act="not_interested">Not interested</button>'+
            '<button class="btn danger" data-act="report">Report</button>'+
          '</footer>'+
        '</article>';
      }

      async function render(){
        var root=qs("#jobs-root"), appRoot=qs("#applied-root"), otherRoot=qs("#other-root");
        root.innerHTML=appRoot.innerHTML=otherRoot.innerHTML="";
        var data = await (await fetch("data.json"+bust(),{cache:"no-store"})).json();
        var list = Array.isArray(data.jobListings)? data.jobListings : [];
        var sections = data.sections || {};
        qs("#total-listings").textContent = "Listings: " + list.length;
        var idsApplied = new Set(sections.applied||[]), idsOther = new Set(sections.other||[]);
        var fP=document.createDocumentFragment(), fA=document.createDocumentFragment(), fO=document.createDocumentFragment();
        if(list.length===0){ root.innerHTML='<div class="empty">No active job listings found.</div>'; return; }

        for(var i=0;i<list.length;i++){
          var job=list[i], wrap=document.createElement("div"); wrap.innerHTML=cardHTML(job); var card=wrap.firstElementChild;
          var jid = job.id;

          card.addEventListener("click", async function(e){
            var b=e.target.closest("[data-act]"); if(!b) return;
            if(b.classList.contains("disabled")) return; // already saved, prevent double
            var act=b.getAttribute("data-act"), id=this.getAttribute("data-id"),
                title=(this.querySelector(".title")?.textContent||"").trim().slice(0,240),
                detailsUrl=(this.querySelector("a.primary")?.href||"");
            var payload=null, labelAfter="";
            if(act==="right"||act==="wrong"){
              payload={ type:"vote", vote:act, jobId:id, title:title, url:detailsUrl, ts:new Date().toISOString() };
              labelAfter = act==="right" ? "Marked ✓" : "Marked ✖";
            }else if(act==="report"){
              qs("#reportListingId").value=id; openModal("#report-modal"); return;
            }else if(act==="applied"||act==="not_interested"){
              payload={ type:"state", payload:{ jobId:id, action:act, ts:new Date().toISOString() } };
              labelAfter = act==="applied" ? "Saved" : "Hidden";
            }
            // confirm minimal
            if(!confirm("Confirm: " + act.replace("_"," ")+ "?")) return;
            var ok = await postJSON(payload);
            if(ok){
              setLocked(b, labelAfter);
              addUndo(this.querySelector(".card-actions"), async ()=>{
                let undoPayload = (act==="applied"||act==="not_interested")
                  ? { type:"state", payload:{ jobId:id, action:"undo", ts:new Date().toISOString() } }
                  : { type:"vote", vote:"undo_"+act, jobId:id, title:title, url:detailsUrl, ts:new Date().toISOString() };
                await postJSON(undoPayload);
                b.classList.remove("disabled"); b.textContent = act==="right"?"Right":act==="wrong"?"Wrong":act==="applied"?"Applied":"Not interested";
              });
            } else {
              alert("Network problem. Please try again.");
            }
          });

          if(idsApplied.has(jid)) fA.appendChild(card);
          else if(idsOther.has(jid)) fO.appendChild(card);
          else fP.appendChild(card);
        }
        root.appendChild(fP); appRoot.appendChild(fA); otherRoot.appendChild(fO);
      }

      document.addEventListener("DOMContentLoaded", function(){
        (async function(){ await renderStatus(); await render(); })();
        document.addEventListener("click", function(e){ if(e.target && e.target.hasAttribute("data-close")){ var m=e.target.closest(".modal"); if(m){ m.classList.add("hidden"); m.setAttribute("aria-hidden","true"); } } });
        qs("#btn-missing")?.addEventListener("click", function(){ openModal("#missing-modal"); });

        qs("#missingForm")?.addEventListener("submit", async function(e){
          e.preventDefault();
          var a=qs("#missingTitle").value.trim(), b=qs("#missingUrl").value.trim(), c=qs("#missingLastDate").value.trim(), d=document.getElementById("missingNote").value.trim();
          if(!a||!b) return alert("Post name and official link are required.");
          var ok = await postJSON({ type:"missing", title:a, url:b, lastDate:c, note:d, ts:new Date().toISOString() });
          if(ok){ var m=e.target.closest(".modal"); m.classList.add("hidden"); m.setAttribute("aria-hidden","true"); e.target.reset(); alert("Saved."); }
        });

        qs("#reportForm")?.addEventListener("submit", async function(e){
          e.preventDefault();
          var id=qs("#reportListingId").value.trim();
          var rc = document.getElementById("reportReason").value || "";
          var rtxt = rc.replace(/_/g," ");
          var ev = document.getElementById("reportEvidenceUrl").value.trim();
          var note = document.getElementById("reportNote").value.trim();
          if(!id || !rc) return alert("Please select a reason.");
          var ok = await postJSON({ type:"report", jobId:id, reasonCode:rc, reasonText:rtxt, evidenceUrl:ev, note:note, ts:new Date().toISOString() });
          if(ok){ var m=e.target.closest(".modal"); m.classList.add("hidden"); m.setAttribute("aria-hidden","true"); e.target.reset(); alert("Reported."); }
        });
      });
    })();
  </script>
</body>
</html>
