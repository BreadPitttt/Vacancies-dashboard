<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>General Vacancy Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta http-equiv="Cache-Control" content="no-store" />
  <link rel="stylesheet" href="style.css" />
  <style>
    .tabs{ display:flex; gap:10px; border-bottom:1px solid #1f2740; margin:10px 0 16px; }
    .tab{ padding:8px 12px; border-radius:8px 8px 0 0; cursor:pointer; color:#bcd2ff; }
    .tab.active{ background:#131a31; border:1px solid #1f2740; border-bottom-color:transparent; }
    .panel{ display:none; }
    .panel.active{ display:block; }
    .card-actions{ flex-wrap: wrap; row-gap: 6px; }
    .btn[data-act="report"]{ min-width: 68px; }
    .applied .card-actions .btn:not([data-act="exam_done"]){ display:none; }
    .badge-done{ padding:2px 8px; border-radius:12px; border:1px solid #2a334f; background:#17203c; color:#99b3ff; margin-left:8px; font-size:12px; }
    /* Toast */
    #toast{ position:fixed;left:50%;bottom:18px;transform:translateX(-50%);background:#141b33;color:#e9eef9;border:1px solid #1f2740;border-radius:10px;padding:8px 12px;font-size:13px;opacity:0;pointer-events:none;transition:opacity .2s ease; z-index: 30; }
    /* Minimal confirm modal */
    #confirm{ position:fixed; inset:0; display:none; align-items:center; justify-content:center; background:rgba(9,12,23,0.6); z-index:25; }
    #confirm .box{ width:min(360px,92vw); background:linear-gradient(180deg,#141a2e,#0f1528); border:1px solid #1f2740; border-radius:12px; padding:14px; color:#e9eef9; }
    #confirm .row{ display:flex; gap:10px; justify-content:flex-end; margin-top:12px; }
  </style>
</head>
<body>
  <header class="topbar">
    <div class="brand">
      <h1>General Vacancy Dashboard</h1>
      <div class="meta">
        <span id="health-pill" class="pill">Health: Unknown</span>
        <span id="last-updated" class="muted">Last updated: —</span>
        <span id="total-listings" class="muted">Listings: —</span>
      </div>
    </div>
    <div class="actions">
      <button id="btn-missing" class="btn ghost" type="button">Submit missing</button>
    </div>
  </header>

  <main class="container">
    <div class="tabs">
      <div class="tab active" data-tab="open">Open</div>
      <div class="tab" data-tab="applied">Applied</div>
      <div class="tab" data-tab="other">Other</div>
    </div>

    <div id="panel-open" class="panel active">
      <div id="open-root" class="cards-grid"></div>
    </div>
    <div id="panel-applied" class="panel">
      <div id="applied-root" class="cards-grid"></div>
    </div>
    <div id="panel-other" class="panel">
      <div id="other-root" class="cards-grid"></div>
    </div>
  </main>

  <!-- Missing modal -->
  <div id="missing-modal" class="modal hidden" aria-hidden="true">
    <div class="modal-body">
      <div class="modal-head">
        <h3>Submit Missing Vacancy</h3>
        <button type="button" class="icon-btn" data-close>&times;</button>
      </div>
      <form id="missingForm" class="form">
        <label>Post name</label>
        <input id="missingTitle" placeholder="e.g., EMRS Non‑teaching 2025" required />
        <div class="grid2">
          <div>
            <label>Notification link (required)</label>
            <input id="missingUrl" placeholder="PDF or notice URL" required />
          </div>
          <div>
            <label>Official website (optional)</label>
            <input id="missingSite" placeholder="https://...gov.in/ or portal home" />
          </div>
        </div>
        <label>Last date (DD-MM-YYYY or N/A)</label>
        <input id="missingLastDate" placeholder="27-10-2025 or N/A" />
        <label>Note (optional)</label>
        <textarea id="missingNote" rows="3" placeholder="Any extra info"></textarea>
        <div class="row end">
          <button type="button" class="btn ghost" data-close>Close</button>
          <button type="submit" class="btn primary">Submit</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Report modal -->
  <div id="report-modal" class="modal hidden" aria-hidden="true">
    <div class="modal-body">
      <div class="modal-head">
        <h3>Report listing</h3>
        <button type="button" class="icon-btn" data-close>&times;</button>
      </div>
      <form id="reportForm" class="form">
        <input type="hidden" id="reportListingId" />
        <label>Reason</label>
        <select id="reportReason" class="select">
          <option value="" disabled selected>Select reason…</option>
          <option value="not_vacancy">Not a vacancy (result/admit/exam date)</option>
          <option value="last_date_over">Last date over</option>
          <option value="wrong_last_date">Wrong last date</option>
          <option value="wrong_eligibility">Wrong eligibility</option>
          <option value="wrong_domicile">Wrong domicile</option>
          <option value="duplicate">Duplicate / Already listed</option>
          <option value="bad_link">Broken / Unofficial link</option>
          <option value="other">Other</option>
        </select>
        <div class="grid2">
          <div>
            <label>Evidence URL (optional)</label>
            <input id="reportEvidenceUrl" placeholder="Official page" />
          </div>
          <div>
            <label>Note (optional)</label>
            <input id="reportNote" placeholder="Tell more if needed" />
          </div>
        </div>
        <div class="row end gap">
          <button type="button" class="btn ghost" data-close>Close</button>
          <button type="submit" class="btn danger">Report</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Custom confirm + toast -->
  <div id="confirm"><div class="box">
    <div id="confirm-text">Confirm?</div>
    <div class="row">
      <button id="confirm-cancel" class="btn ghost">Cancel</button>
      <button id="confirm-ok" class="btn primary">OK</button>
    </div>
  </div></div>
  <div id="toast"></div>

  <script>
    (function(){
      var ENDPOINT = "https://vacancy.animeshkumar97.workers.dev";
      var bust = function(){ return "?t=" + Date.now(); };

      function qs(s, r){ return (r||document).querySelector(s); }
      function qsa(s, r){ return Array.from((r||document).querySelectorAll(s)); }
      function esc(s){ return (s==null? "": String(s)).replace(/[&<>\"']/g, function(c){ return {"&":"&amp;","<":"&lt;","&gt;":"&gt;","\"":"&quot;","'":""}[c]; }); }
      function fmtDate(s){ return s && s.toUpperCase()!=="N/A" ? s : "N/A"; }
      function toast(msg){ var t=document.getElementById("toast"); if(!t) return alert(msg); t.textContent=msg; t.style.opacity="1"; clearTimeout(t._h); t._h=setTimeout(()=>{ t.style.opacity="0"; }, 1600); }

      // Minimal confirm (replaces window.confirm)
      function confirmBox(message){
        return new Promise(res=>{
          var c=qs("#confirm"); qs("#confirm-text").textContent = message || "Confirm?";
          c.style.display="flex";
          function done(v){ c.style.display="none"; ok.removeEventListener("click",okH); cancel.removeEventListener("click",cancelH); res(v); }
          var ok=qs("#confirm-ok"), cancel=qs("#confirm-cancel");
          function okH(){ done(true); } function cancelH(){ done(false); }
          ok.addEventListener("click", okH); cancel.addEventListener("click", cancelH);
        });
      }

      // Tabs
      function activate(tab){
        qsa(".tab").forEach(t=>t.classList.toggle("active", t.dataset.tab===tab));
        qsa(".panel").forEach(p=>p.classList.toggle("active", p.id==="panel-"+tab));
      }
      document.addEventListener("click", function(e){
        var t=e.target.closest(".tab"); if(!t) return;
        activate(t.dataset.tab);
      });

      // User state cache (server + local)
      var USER_STATE = {};
      async function loadUserState(){
        try{
          var res = await fetch("user_state.json"+bust(), { cache:"no-store" });
          if(res.ok) USER_STATE = await res.json();
        }catch{}
        try{
          var local = JSON.parse(localStorage.getItem("vac_user_state")||"{}");
          if(local && typeof local==="object") USER_STATE = Object.assign({}, USER_STATE, local);
        }catch{}
      }
      function setUserState(jobId, action){
        if(!jobId) return;
        if(action==="undo") delete USER_STATE[jobId];
        else USER_STATE[jobId] = { action: action, ts: new Date().toISOString() };
        try{ localStorage.setItem("vac_user_state", JSON.stringify(USER_STATE)); }catch{}
      }

      // Persist votes locally too so Right/Wrong is not lost on refresh
      var USER_VOTES = {};
      function loadVotesLocal(){
        try{ USER_VOTES = JSON.parse(localStorage.getItem("vac_user_votes")||"{}") || {}; }catch{ USER_VOTES={}; }
      }
      function setVoteLocal(jobId, vote){
        USER_VOTES[jobId] = { vote: vote, ts: new Date().toISOString() };
        try{ localStorage.setItem("vac_user_votes", JSON.stringify(USER_VOTES)); }catch{}
      }
      function clearVoteLocal(jobId){ delete USER_VOTES[jobId]; try{ localStorage.setItem("vac_user_votes", JSON.stringify(USER_VOTES)); }catch{} }

      async function postJSON(payload){
        try{
          var res = await fetch(ENDPOINT, { method:"POST", headers:{ "Content-Type":"application/json" }, body: JSON.stringify(payload) });
          return res.ok;
        }catch(e){ return false; }
      }

      async function renderStatus(){
        var pill=qs("#health-pill"), last=qs("#last-updated"), total=qs("#total-listings");
        try{
          var h=await (await fetch("health.json"+bust(),{cache:"no-store"})).json();
          pill.textContent=h.ok?"Health: OK":"Health: Not OK"; pill.className="pill "+(h.ok?"ok":"bad");
          var ts=h.lastUpdated||""; last.textContent="Last updated: "+(ts?new Date(ts).toLocaleString():"—");
          total.textContent="Listings: "+(typeof h.totalListings==="number"?h.totalListings:"—");
        }catch(e){
          pill.textContent="Health: Unknown"; pill.className="pill";
          last.textContent="Last updated: —"; total.textContent="Listings: —";
        }
      }

      function setLocked(btn, label){
        btn.textContent = label; btn.classList.add("disabled"); btn.setAttribute("aria-disabled","true");
      }
      function addUndo(container, onUndo){
        var u=document.createElement("button"); u.className="btn ghost tiny"; u.textContent="Undo";
        u.addEventListener("click", function(e){ e.preventDefault(); e.stopPropagation(); onUndo(); u.remove(); });
        container.appendChild(u);
      }

      function cardHTML(j, applied=false){
        var b=j.flags&&j.flags.trusted, chip=b?'<span class="chip ok">✓ trusted</span>':"";
        var d=j.daysLeft!=null?j.daysLeft:"—";
        var det=esc(j.detailLink||j.applyLink||"#");
        var appliedBadge = applied ? '<span class="badge-done">Applied</span>' : '';
        var srcRibbon = (j.source||"").toLowerCase()==="official"
          ? '<span class="chip" title="Official source">Official</span>'
          : '<span class="chip" title="From aggregator">Agg</span>';

        // Indicate local vote
        var lid = j.id||"";
        var voteChip = "";
        if(USER_VOTES[lid]?.vote==="right") voteChip = '<span class="chip ok" title="Marked right">✓</span>';
        if(USER_VOTES[lid]?.vote==="wrong") voteChip = '<span class="chip" title="Marked wrong">✖</span>';

        return '<article class="card'+(applied?' applied':'')+'" data-id="'+esc(lid)+'">'+
          '<header class="card-head"><h3 class="title">'+esc(j.title||"No Title")+'</h3>'+srcRibbon+voteChip+chip+appliedBadge+'</header>'+
          '<div class="card-body">'+
            '<div class="rowline"><span class="muted">Organization</span><span>'+esc(j.organization||"N/A")+'</span></div>'+
            '<div class="rowline"><span class="muted">Qualification</span><span>'+esc(j.qualificationLevel||"N/A")+'</span></div>'+
            '<div class="rowline"><span class="muted">Domicile</span><span>'+esc(j.domicile||"All India")+'</span></div>'+
            '<div class="rowline"><span class="muted">Last date</span><span>'+esc(fmtDate(j.deadline))+' <span class="muted">('+d+' days)</span></span></div>'+
          '</div>'+
          '<footer class="card-actions">'+
            '<button class="btn danger" data-act="report">Report</button>'+
            '<a class="btn primary" href="'+det+'" target="_blank" rel="noopener">Details</a>'+
            '<span class="spacer"></span>'+
            (applied ? '<button class="btn" data-act="exam_done">Exam done</button>'
                     : '<button class="btn ok" data-act="right">Right</button><button class="btn warn" data-act="wrong">Wrong</button><button class="btn" data-act="applied">Applied</button><button class="btn" data-act="not_interested">Not interested</button>')+
          '</footer>'+
        '</article>';
      }

      function sortByDeadline(list){
        const parse = (s)=>{
          if(!s||s.toUpperCase()==="N/A") return null;
          const t=s.replaceAll("-","/"); const a=t.split("/"); if(a.length!==3) return null;
          const ms = Date.UTC(+a[2], +a[1]-1, +a[0]); return isNaN(ms)?null:ms;
        };
        return list.slice().sort((a,b)=>{
          const da=parse(a.deadline), db=parse(b.deadline);
          if(da===null && db===null) return (a.title||"").localeCompare(b.title||"");
          if(da===null) return 1; if(db===null) return -1; return da - db;
        });
      }

      async function render(){
        var rootOpen=qs("#open-root"), rootApp=qs("#applied-root"), rootOther=qs("#other-root");
        rootOpen.innerHTML=rootApp.innerHTML=rootOther.innerHTML="";

        var data = await (await fetch("data.json"+bust(),{cache:"no-store"})).json();
        var list = sortByDeadline(Array.isArray(data.jobListings)? data.jobListings : []);
        var sections = data.sections || {};
        qs("#total-listings").textContent = "Listings: " + list.length;

        var idsApplied = new Set(sections.applied||[]);
        var idsOther = new Set(sections.other||[]);
        Object.entries(USER_STATE).forEach(([jid, s])=>{
          if(!s || !s.action) return;
          if(s.action==="applied"){ idsApplied.add(jid); idsOther.delete(jid); }
          if(s.action==="not_interested"){ idsOther.add(jid); idsApplied.delete(jid); }
          if(s.action==="undo"){ idsApplied.delete(jid); idsOther.delete(jid); }
        });

        var fOpen=document.createDocumentFragment(), fApp=document.createDocumentFragment(), fOther=document.createDocumentFragment();
        if(list.length===0){ rootOpen.innerHTML='<div class="empty">No active job listings found.</div>'; return; }

        for(const job of list){
          const isApplied = idsApplied.has(job.id);
          const wrap=document.createElement("div");
          wrap.innerHTML = cardHTML(job, isApplied);
          const card=wrap.firstElementChild;

          card.addEventListener("click", async function(e){
            const b=e.target.closest("[data-act]"); if(!b) return;
            if(b.classList.contains("disabled")) return;
            const act=b.getAttribute("data-act"), id=this.getAttribute("data-id"),
                  title=(this.querySelector(".title")?.textContent||"").trim().slice(0,240),
                  detailsUrl=(this.querySelector("a.primary")?.href||"");
            let payload=null, labelAfter="";
            if(act==="right"||act==="wrong"){
              const okDialog = await confirmBox("Confirm: "+(act==="right"?"mark right":"mark wrong")+"?");
              if(!okDialog) return;
              // write local votes immediately so refresh keeps state
              setVoteLocal(id, act);
              payload={ type:"vote", vote:act, jobId:id, title:title, url:detailsUrl, ts:new Date().toISOString() };
              labelAfter= act==="right"?"Marked ✓":"Marked ✖";
              const ok=await postJSON(payload);
              if(!ok){ toast("Network problem. Saved locally."); }
              setLocked(b,labelAfter);
              addUndo(this.querySelector(".card-actions"), async ()=>{
                clearVoteLocal(id);
                const undo={ type:"vote", vote:"undo_"+act, jobId:id, title:title, url:detailsUrl, ts:new Date().toISOString() };
                await postJSON(undo);
                await render();
              });
              return;
            }else if(act==="report"){
              qs("#reportListingId").value=id; document.getElementById("report-modal").classList.remove("hidden"); document.getElementById("report-modal").setAttribute("aria-hidden","false"); return;
            }else if(act==="applied"||act==="not_interested"){
              const okDialog = await confirmBox("Confirm: "+act.replace("_"," ")+"?");
              if(!okDialog) return;
              // write state locally first for immediate persistence
              setUserState(id, act);
              payload={ type:"state", payload:{ jobId:id, action:act, ts:new Date().toISOString() } };
              const ok=await postJSON(payload);
              if(!ok){ toast("Network problem. Saved locally."); }
              await render(); // reflow into tabs
              return;
            }else if(act==="exam_done"){
              setLocked(b,"Done ✓"); return;
            }
          });

          if(isApplied) fApp.appendChild(card);
          else if(idsOther.has(job.id)) fOther.appendChild(card);
          else fOpen.appendChild(card);
        }

        rootOpen.appendChild(fOpen);
        rootApp.appendChild(fApp);
        rootOther.appendChild(fOther);
      }

      function openModal(id){ var m=qs(id); if(m){ m.classList.remove("hidden"); m.setAttribute("aria-hidden","false"); } }
      function closeModal(el){ var m=el.closest(".modal"); if(m){ m.classList.add("hidden"); m.setAttribute("aria-hidden","true"); } }

      document.addEventListener("click", function(e){ if(e.target && e.target.hasAttribute("data-close")){ closeModal(e.target); } });

      document.addEventListener("DOMContentLoaded", async function(){
        loadVotesLocal();
        await loadUserState();           // ensure state is present before first render
        await renderStatus();
        await render();

        qs("#btn-missing")?.addEventListener("click", function(){ openModal("#missing-modal"); });

        qs("#reportForm")?.addEventListener("submit", async function(e){
          e.preventDefault();
          var id=qs("#reportListingId").value.trim();
          var rc = document.getElementById("reportReason").value || "";
          var rtxt = rc.replace(/_/g," ");
          var ev = document.getElementById("reportEvidenceUrl").value.trim();
          var note = document.getElementById("reportNote").value.trim();
          if(!id || !rc) return toast("Please select a reason.");
          var ok = await postJSON({ type:"report", jobId:id, reasonCode:rc, reasonText:rtxt, evidenceUrl:ev, note:note, ts:new Date().toISOString() });
          if(ok){ closeModal(e.target); e.target.reset(); toast("Reported."); }
        });

        // Missing guard
        var SUBMIT_LOCK = new Set();
        qs("#missingForm")?.addEventListener("submit", async function(e){
          e.preventDefault();
          var title=qs("#missingTitle").value.trim();
          var url=qs("#missingUrl").value.trim();
          var site=qs("#missingSite").value.trim();
          var last=qs("#missingLastDate").value.trim();
          var note=document.getElementById("missingNote").value.trim();
          if(!title||!url) return toast("Post name and notification link are required.");
          var key = url.replace(/[?#].*$/,"").toLowerCase();
          if(SUBMIT_LOCK.has(key)) return toast("Already submitted.");
          SUBMIT_LOCK.add(key);
          var ok = await postJSON({ type:"missing", title:title, url:url, officialSite:site, lastDate:last, note:note, ts:new Date().toISOString() });
          if(ok){ closeModal(e.target); e.target.reset(); toast("Saved. Will appear after refresh."); }
          else { toast("Network problem. Please try again."); SUBMIT_LOCK.delete(key); }
        });
      });
    })();
  </script>
</body>
</html>
