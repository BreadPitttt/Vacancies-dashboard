<!doctype html>
<html lang="en" class="dark">
<head>
  <meta charset="utf-8" />
  <title>General Vacancy Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta http-equiv="Cache-Control" content="no-store" />
  <!-- TailAdmin core: Tailwind + base styles (CDN build) -->
  <link rel="preconnect" href="https://cdn.jsdelivr.net" />
  <script src="https://cdn.tailwindcss.com/3.4.10"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@tabler/icons-webfont@3.12.0/tabler-icons.min.css" />
  <!-- Minimal TailAdmin palette -->
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          colors: {
            primary: { DEFAULT: '#3C82F6' },
            surface: '#0b1220',
            card: '#0f172a',
            border: '#1e293b',
            muted: '#94a3b8',
          }
        }
      }
    }
  </script>
  <!-- Local overrides (keep last) -->
  <link rel="stylesheet" href="style.css" />
</head>
<body class="bg-surface text-slate-200">
  <!-- Top bar -->
  <header class="sticky top-0 z-30 backdrop-blur bg-surface/80 border-b border-border">
    <div class="mx-auto max-w-7xl px-4 py-3 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <div class="h-8 w-8 rounded bg-primary/20 flex items-center justify-center text-primary">
          <i class="ti ti-clipboard-text"></i>
        </div>
        <div>
          <h1 class="text-lg font-semibold">General Vacancy Dashboard</h1>
          <div class="text-sm text-muted flex items-center gap-3">
            <span id="health-pill" class="inline-flex items-center px-2 py-0.5 rounded border border-border">Health: Unknown</span>
            <span id="last-updated">Last updated: —</span>
            <span id="total-listings">Listings: —</span>
          </div>
        </div>
      </div>
      <button id="btn-missing" class="px-3 py-1.5 rounded border border-primary/40 text-primary hover:bg-primary/10">Submit missing</button>
    </div>
  </header>

  <!-- Tabs -->
  <main class="mx-auto max-w-7xl px-4 py-6">
    <div class="flex items-center gap-2 border-b border-border mb-4">
      <button class="tab active px-3 py-2 rounded-t bg-card text-slate-100 border border-border border-b-transparent" data-tab="open">Open</button>
      <button class="tab px-3 py-2 rounded-t text-slate-300 hover:text-white" data-tab="applied">Applied</button>
      <button class="tab px-3 py-2 rounded-t text-slate-300 hover:text-white" data-tab="other">Other</button>
      <div class="ml-auto flex items-center gap-2 text-sm text-muted">
        <span class="hidden md:inline">Dark</span>
        <label class="relative inline-flex cursor-pointer items-center">
          <input id="toggle-theme" type="checkbox" class="peer sr-only" checked>
          <div class="h-5 w-10 rounded-full bg-slate-600 peer-checked:bg-primary/70 after:content-[''] after:absolute after:top-0.5 after:left-0.5 after:h-4 after:w-4 after:rounded-full after:bg-white after:transition-all peer-checked:after:translate-x-5"></div>
        </label>
      </div>
    </div>

    <!-- Panels -->
    <section id="panel-open" class="panel active">
      <div id="open-root" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-4"></div>
    </section>
    <section id="panel-applied" class="panel">
      <div id="applied-root" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-4"></div>
    </section>
    <section id="panel-other" class="panel">
      <div id="other-root" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-4"></div>
    </section>
  </main>

  <!-- Missing modal -->
  <div id="missing-modal" class="modal hidden" aria-hidden="true">
    <div class="modal-body w-[min(680px,92vw)]">
      <div class="modal-head">
        <h3>Submit Missing Vacancy</h3>
        <button type="button" class="icon-btn" data-close>&times;</button>
      </div>
      <form id="missingForm" class="form">
        <label>Post name</label>
        <input id="missingTitle" placeholder="e.g., EMRS Non‑teaching 2025" required />
        <div class="grid2">
          <div>
            <label>Notification link (required)</label>
            <input id="missingUrl" placeholder="PDF or notice URL" required />
          </div>
          <div>
            <label>Official website (optional)</label>
            <input id="missingSite" placeholder="https://...gov.in/ or portal home" />
          </div>
        </div>
        <label>Last date (DD-MM-YYYY or N/A)</label>
        <input id="missingLastDate" placeholder="27-10-2025 or N/A" />
        <label>Note (optional)</label>
        <textarea id="missingNote" rows="3" placeholder="Any extra info"></textarea>
        <div class="row end">
          <button type="button" class="btn ghost" data-close>Close</button>
          <button type="submit" class="btn primary">Submit</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Report modal -->
  <div id="report-modal" class="modal hidden" aria-hidden="true">
    <div class="modal-body w-[min(680px,92vw)]">
      <div class="modal-head">
        <h3>Report listing</h3>
        <button type="button" class="icon-btn" data-close>&times;</button>
      </div>
      <form id="reportForm" class="form">
        <input type="hidden" id="reportListingId" />
        <label>Reason</label>
        <select id="reportReason" class="select">
          <option value="" disabled selected>Select reason…</option>
          <option value="not_vacancy">Not a vacancy (result/admit/exam date)</option>
          <option value="last_date_over">Last date over</option>
          <option value="wrong_last_date">Wrong last date</option>
          <option value="wrong_eligibility">Wrong eligibility</option>
          <option value="wrong_domicile">Wrong domicile</option>
          <option value="duplicate">Duplicate / Already listed</option>
          <option value="bad_link">Broken / Unofficial link</option>
          <option value="other">Other</option>
        </select>
        <div class="grid2">
          <div>
            <label>Evidence URL (optional)</label>
            <input id="reportEvidenceUrl" placeholder="Official page" />
          </div>
          <div>
            <label>Note (optional)</label>
            <input id="reportNote" placeholder="Tell more if needed" />
          </div>
        </div>
        <div class="row end gap">
          <button type="button" class="btn ghost" data-close>Close</button>
          <button type="submit" class="btn danger">Report</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Custom confirm + snackbar + toast -->
  <div id="confirm" class="fixed inset-0 hidden items-center justify-center bg-black/50 z-40">
    <div class="box bg-card border border-border rounded-xl p-4 w-[min(360px,92vw)] shadow-lg">
      <div id="confirm-text" class="text-slate-100">Confirm?</div>
      <div class="mt-3 flex justify-end gap-2 flex-row-reverse">
        <button id="confirm-cancel" class="px-3 py-1.5 rounded border border-border text-slate-300">Cancel</button>
        <button id="confirm-ok" class="px-3 py-1.5 rounded bg-primary text-white">OK</button>
      </div>
    </div>
  </div>

  <div id="snackbar" class="hidden fixed left-1/2 -translate-x-1/2 bottom-16 bg-card border border-border rounded-xl px-3 py-2 z-40 items-center gap-3">
    <span id="snack-text">Saved</span>
    <span id="snack-count" class="text-primary/80">(10s)</span>
    <button id="snack-undo" class="px-2 py-1 rounded border border-border">Undo</button>
  </div>

  <div id="toast" class="fixed left-1/2 -translate-x-1/2 bottom-4 bg-card border border-border rounded-xl px-3 py-2 z-40 opacity-0 pointer-events-none"></div>

  <!-- App script: identical logic from the latest version (tabs, render, confirm/snackbar, votes, applied persistence) -->
  <script>
    (function(){
      var ENDPOINT = "https://vacancy.animeshkumar97.workers.dev";
      var bust = function(){ return "?t=" + Date.now(); };

      // Theme toggle (kept minimal)
      const toggle = document.getElementById('toggle-theme');
      if (toggle) {
        toggle.addEventListener('change', () => {
          document.documentElement.classList.toggle('dark', toggle.checked);
        });
      }

      function qs(s, r){ return (r||document).querySelector(s); }
      function qsa(s, r){ return Array.from((r||document).querySelectorAll(s)); }
      function esc(s){ return (s==null? "": String(s)).replace(/[&<>\"']/g, c => ({ "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"" }[c])); }
      function fmtDate(s){ return s && s.toUpperCase()!=="N/A" ? s : "N/A"; }
      function toast(msg){ var t=qs("#toast"); if(!t) return alert(msg); t.textContent=msg; t.style.opacity="1"; clearTimeout(t._h); t._h=setTimeout(()=>{ t.style.opacity="0"; }, 1600); }

      // Global snackbar
      var LAST_ACTION = null, SNACK_TIMER=null, SNACK_LEFT=0;
      function showSnack(text, seconds, undoFn){
        var s=qs("#snackbar"); qs("#snack-text").textContent=text; SNACK_LEFT=seconds;
        qs("#snack-count").textContent="("+SNACK_LEFT+"s)"; s.classList.remove('hidden'); s.classList.add('flex');
        clearInterval(SNACK_TIMER);
        SNACK_TIMER=setInterval(()=>{ SNACK_LEFT--; if(SNACK_LEFT<=0){ hideSnack(); } else { qs("#snack-count").textContent="("+SNACK_LEFT+"s)"; } }, 1000);
        qs("#snack-undo").onclick = async function(){ hideSnack(); await undoFn(); };
      }
      function hideSnack(){ var s=qs("#snackbar"); s.classList.add('hidden'); s.classList.remove('flex'); clearInterval(SNACK_TIMER); SNACK_TIMER=null; }

      function confirmBox(message){
        return new Promise(res=>{
          var c=qs("#confirm"); qs("#confirm-text").textContent = message || "Confirm?";
          c.classList.remove('hidden'); c.classList.add('flex');
          function done(v){ c.classList.add('hidden'); c.classList.remove('flex'); ok.removeEventListener("click",okH); cancel.removeEventListener("click",cancelH); res(v); }
          var ok=qs("#confirm-ok"), cancel=qs("#confirm-cancel");
          function okH(){ done(true); } function cancelH(){ done(false); }
          ok.addEventListener("click", okH); cancel.addEventListener("click", cancelH);
        });
      }

      // Tabs
      function activate(tab){
        qsa(".tab").forEach(t=>t.classList.toggle("active", t.dataset.tab===tab));
        qsa(".panel").forEach(p=>p.classList.toggle("active", p.id==="panel-"+tab));
      }
      document.addEventListener("click", function(e){
        var t=e.target.closest(".tab"); if(!t) return;
        qsa(".tab").forEach(btn=>{
          btn.classList.remove("bg-card","border","border-border","border-b-transparent","text-slate-100");
          btn.classList.add("text-slate-300");
        });
        t.classList.add("bg-card","border","border-border","border-b-transparent","text-slate-100");
        activate(t.dataset.tab);
      });

      // State
      var USER_STATE={}, USER_VOTES={};
      async function loadUserStateServer(){ try{ const r=await fetch("user_state.json"+bust(),{cache:"no-store"}); if(r.ok){ USER_STATE=await r.json(); } }catch{} }
      function loadUserStateLocal(){ try{ const j=JSON.parse(localStorage.getItem("vac_user_state")||"{}"); if(j) USER_STATE=Object.assign({}, USER_STATE, j); }catch{} }
      function setUserStateLocal(jobId, action){ if(!jobId) return; if(action==="undo") delete USER_STATE[jobId]; else USER_STATE[jobId]={action, ts:new Date().toISOString()}; try{ localStorage.setItem("vac_user_state", JSON.stringify(USER_STATE)); }catch{} }
      function loadVotesLocal(){ try{ USER_VOTES=JSON.parse(localStorage.getItem("vac_user_votes")||"{}")||{}; }catch{ USER_VOTES={}; } }
      function setVoteLocal(jobId, vote){ USER_VOTES[jobId]={vote, ts:new Date().toISOString()}; try{ localStorage.setItem("vac_user_votes", JSON.stringify(USER_VOTES)); }catch{} }
      function clearVoteLocal(jobId){ delete USER_VOTES[jobId]; try{ localStorage.setItem("vac_user_votes", JSON.stringify(USER_VOTES)); }catch{} }

      async function postJSON(payload){
        try{ var res = await fetch(ENDPOINT, { method:"POST", headers:{ "Content-Type":"application/json" }, body: JSON.stringify(payload) }); return res.ok; }
        catch(e){ return false; }
      }

      async function renderStatus(){
        var pill=qs("#health-pill"), last=qs("#last-updated"), total=qs("#total-listings");
        try{
          var h=await (await fetch("health.json"+bust(),{cache:"no-store"})).json();
          pill.textContent=h.ok?"Health: OK":"Health: Not OK";
          pill.className="inline-flex items-center px-2 py-0.5 rounded border "+(h.ok?"border-emerald-500/40 text-emerald-300":"border-red-500/40 text-red-300");
          var ts=h.lastUpdated||""; last.textContent="Last updated: "+(ts?new Date(ts).toLocaleString():"—");
          total.textContent="Listings: "+(typeof h.totalListings==="number"?h.totalListings:"—");
        }catch(e){
          pill.textContent="Health: Unknown"; pill.className="inline-flex items-center px-2 py-0.5 rounded border border-border";
          last.textContent="Last updated: —"; total.textContent="Listings: —";
        }
      }

      function addUndo(container, onUndo, seconds){
        var u=document.createElement("button");
        u.className="px-2 py-1 rounded border border-border text-slate-300 text-sm"; u.textContent="Undo ("+seconds+"s)";
        container.appendChild(u);
        var left=seconds; var iv=setInterval(()=>{ left--; if(left<=0){ clearInterval(iv); u.remove(); } else { u.textContent="Undo ("+left+"s)"; } },1000);
        u.addEventListener("click", function(e){ e.preventDefault(); e.stopPropagation(); clearInterval(iv); u.remove(); onUndo(); });
      }

      function cardHTML(j, applied=false){
        var trusted=j.flags&&j.flags.trusted, chip=trusted?'<span class="ml-2 inline-flex items-center text-emerald-300 text-xs border border-emerald-500/40 rounded px-1.5">✓ trusted</span>':"";
        var d=j.daysLeft!=null?j.daysLeft:"—";
        var det=esc(j.detailLink||j.applyLink||"#");
        var appliedBadge = applied ? '<span class="ml-2 inline-flex items-center text-primary text-xs border border-primary/40 rounded px-1.5">Applied</span>' : '';
        var srcRibbon = (j.source||"").toLowerCase()==="official" ? '<span class="ml-2 inline-flex items-center text-primary text-xs border border-primary/40 rounded px-1.5">Official</span>' : '<span class="ml-2 inline-flex items-center text-slate-300 text-xs border border-border rounded px-1.5">Agg</span>';
        var lid=j.id||"", vote = USER_VOTES[lid]?.vote || "";
        var voteTick = vote==="right" ? '<span class="ml-2 inline-flex items-center text-emerald-300 text-xs border border-emerald-500/40 rounded px-1.5">✓</span>' : "";
        var verifiedClass = vote==="right" ? " verified" : "";

        return '<article class="card '+verifiedClass+' bg-card border border-border rounded-xl p-4" data-id="'+esc(lid)+'">'+
          '<header class="flex items-start justify-between gap-2 mb-3"><h3 class="title text-base font-semibold text-slate-100">'+esc(j.title||"No Title")+'</h3><div class="flex items-center">'+srcRibbon+voteTick+chip+appliedBadge+'</div></header>'+
          '<div class="space-y-2 text-sm text-slate-300">'+
            '<div class="flex items-center justify-between"><span class="text-muted">Organization</span><span>'+esc(j.organization||"N/A")+'</span></div>'+
            '<div class="flex items-center justify-between"><span class="text-muted">Qualification</span><span>'+esc(j.qualificationLevel||"N/A")+'</span></div>'+
            '<div class="flex items-center justify-between"><span class="text-muted">Domicile</span><span>'+esc(j.domicile||"All India")+'</span></div>'+
            '<div class="flex items-center justify-between"><span class="text-muted">Last date</span><span>'+esc(fmtDate(j.deadline))+' <span class="text-muted">('+d+' days)</span></span></div>'+
          '</div>'+
          '<footer class="mt-4 flex flex-wrap items-center gap-2">'+
            '<span class="hide-on-verified inline-flex gap-2">'+
              '<button class="btn danger" data-act="report">Report</button>'+
              '<button class="btn ok" data-act="right">Right</button>'+
              '<button class="btn warn" data-act="wrong">Wrong</button>'+
            '</span>'+
            '<a class="btn primary" href="'+det+'" target="_blank" rel="noopener">Details</a>'+
            '<span class="flex-1"></span>'+
            (applied ? '<button class="btn" data-act="exam_done">Exam done</button>'
                     : '<button class="btn" data-act="applied">Applied</button><button class="btn" data-act="not_interested">Not interested</button>')+
          '</footer>'+
        '</article>';
      }

      function sortByDeadline(list){
        const parse = (s)=>{ if(!s||s.toUpperCase()==="N/A") return null; const t=s.replaceAll("-","/"); const a=t.split("/"); if(a.length!==3) return null; const ms=Date.UTC(+a[2], +a[1]-1, +a[0]); return isNaN(ms)?null:ms; };
        return list.slice().sort((a,b)=>{ const da=parse(a.deadline), db=parse(b.deadline); if(da===null && db===null) return (a.title||"").localeCompare(b.title||""); if(da===null) return 1; if(db===null) return -1; return da - db; });
      }

      async function render(){
        var rootOpen=qs("#open-root"), rootApp=qs("#applied-root"), rootOther=qs("#other-root");
        rootOpen.innerHTML=rootApp.innerHTML=rootOther.innerHTML="";

        await loadUserStateServer(); loadUserStateLocal(); loadVotesLocal();

        var data = await (await fetch("data.json"+bust(),{cache:"no-store"})).json();
        var list = sortByDeadline(Array.isArray(data.jobListings)? data.jobListings : []);
        var sections = data.sections || {};
        qs("#total-listings").textContent = "Listings: " + list.length;

        var idsApplied = new Set(sections.applied||[]);
        var idsOther = new Set(sections.other||[]);
        Object.entries(USER_STATE).forEach(([jid, s])=>{
          if(!s || !s.action) return;
          if(s.action==="applied"){ idsApplied.add(jid); idsOther.delete(jid); }
          if(s.action==="not_interested"){ idsOther.add(jid); idsApplied.delete(jid); }
          if(s.action==="undo"){ idsApplied.delete(jid); idsOther.delete(jid); }
        });

        var fOpen=document.createDocumentFragment(), fApp=document.createDocumentFragment(), fOther=document.createDocumentFragment();
        if(list.length===0){ rootOpen.innerHTML='<div class="text-center text-muted py-12">No active job listings found.</div>'; return; }

        for(const job of list){
          const isApplied = idsApplied.has(job.id);
          const wrap=document.createElement("div");
          wrap.innerHTML = cardHTML(job, isApplied);
          const card=wrap.firstElementChild;

          card.addEventListener("click", async function(e){
            const b=e.target.closest("[data-act]"); if(!b) return;
            if(b.classList.contains("disabled")) return;
            const act=b.getAttribute("data-act"), id=this.getAttribute("data-id"),
                  title=(this.querySelector(".title")?.textContent||"").trim().slice(0,240),
                  detailsUrl=(this.querySelector("a.btn.primary")?.href||"");
            const actions = this.querySelector(".hide-on-verified");

            if(act==="report"){
              qs("#reportListingId").value=id; qs("#report-modal").classList.remove("hidden"); return;
            }

            if(act==="right"){
              const ok = await confirmBox("Confirm: mark right?");
              if(!ok) return;
              // local verify
              USER_VOTES[id]={vote:"right", ts:new Date().toISOString()};
              localStorage.setItem("vac_user_votes", JSON.stringify(USER_VOTES));
              this.classList.add("verified"); if(actions) actions.style.display="none";
              const undoFn = async ()=>{ delete USER_VOTES[id]; localStorage.setItem("vac_user_votes", JSON.stringify(USER_VOTES)); await postJSON({ type:"vote", vote:"undo_right", jobId:id, title:title, url:detailsUrl, ts:new Date().toISOString() }); await render(); };
              addUndo(this.querySelector("footer"), undoFn, 10);
              LAST_ACTION = { type:"vote_right", jobId:id, undo:undoFn };
              showSnack("Saved ✓", 10, undoFn);
              postJSON({ type:"vote", vote:"right", jobId:id, title:title, url:detailsUrl, ts:new Date().toISOString() }).then(r=>{ if(!r) toast("Network problem. Saved locally."); });
              return;
            }

            if(act==="wrong"){
              const ok = await confirmBox("Confirm: mark wrong?");
              if(!ok) return;
              USER_VOTES[id]={vote:"wrong", ts:new Date().toISOString()};
              localStorage.setItem("vac_user_votes", JSON.stringify(USER_VOTES));
              const undoFn = async ()=>{ delete USER_VOTES[id]; localStorage.setItem("vac_user_votes", JSON.stringify(USER_VOTES)); await postJSON({ type:"vote", vote:"undo_wrong", jobId:id, title:title, url:detailsUrl, ts:new Date().toISOString() }); await render(); };
              addUndo(this.querySelector("footer"), undoFn, 10);
              LAST_ACTION = { type:"vote_wrong", jobId:id, undo:undoFn };
              showSnack("Saved ✖", 10, undoFn);
              postJSON({ type:"vote", vote:"wrong", jobId:id, title:title, url:detailsUrl, ts:new Date().toISOString() }).then(r=>{ if(!r) toast("Network problem. Saved
