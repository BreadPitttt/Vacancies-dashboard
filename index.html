<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>General Vacancy Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta http-equiv="Cache-Control" content="no-store" />
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <header class="topbar">
    <div class="brand">
      <h1>General Vacancy Dashboard</h1>
      <div class="meta">
        <span id="health-pill" class="pill">Health: Unknown</span>
        <span id="last-updated" class="muted">Last updated: —</span>
        <span id="total-listings" class="muted">Listings: —</span>
      </div>
    </div>
    <div class="actions">
      <button id="btn-missing" class="btn ghost">Submit missing</button>
    </div>
  </header>

  <main class="container">
    <section>
      <h2 class="section-title">Open vacancies</h2>
      <div id="jobs-root" class="cards-grid"></div>
    </section>

    <section>
      <h2 class="section-title">Applied</h2>
      <div id="applied-root" class="cards-grid"></div>
    </section>

    <section>
      <h2 class="section-title">Other</h2>
      <div id="other-root" class="cards-grid"></div>
    </section>
  </main>

  <!-- Missing Vacancy Modal -->
  <div id="missing-modal" class="modal hidden" aria-hidden="true">
    <div class="modal-body">
      <div class="modal-head">
        <h3>Submit Missing Vacancy</h3>
        <button type="button" class="icon-btn" data-close>&times;</button>
      </div>
      <form id="missingForm" class="form">
        <label>Post name</label>
        <input id="missingTitle" placeholder="e.g., BSSC 4th Graduate Level 2025" required />
        <label>Notification link (official)</label>
        <input id="missingUrl" placeholder="https://...gov.in/..." required />
        <label>Last date (DD-MM-YYYY or N/A)</label>
        <input id="missingLastDate" placeholder="27-10-2025 or N/A" />
        <label>Note (optional)</label>
        <textarea id="missingNote" rows="3" placeholder="Any extra info"></textarea>
        <div class="row end">
          <button type="button" class="btn ghost" data-close>Close</button>
          <button type="submit" class="btn primary">Submit</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Report Modal -->
  <div id="report-modal" class="modal hidden" aria-hidden="true">
    <div class="modal-body">
      <div class="modal-head">
        <h3>Report Listing</h3>
        <button type="button" class="icon-btn" data-close>&times;</button>
      </div>
      <form id="reportForm" class="form">
        <input type="hidden" id="reportListingId" />
        <label>Reason</label>
        <input id="reportReason" placeholder="Why is this wrong?" />
        <label>Evidence URL (optional)</label>
        <input id="reportEvidenceUrl" placeholder="https://..." />
        <label>Note (optional)</label>
        <textarea id="reportNote" rows="3"></textarea>
        <div class="row end">
          <button type="button" class="btn ghost" data-close>Close</button>
          <button type="submit" class="btn danger">Report</button>
        </div>
      </form>
    </div>
  </div>

  <script>
    // Config
    const CF_BASE = 'https://649b07cd.vacancies-dashboard.pages.dev';
    const feedbackEndpoint = CF_BASE + '/feedback';
    const bust = () => `?t=${Date.now()}`;

    // Small helpers
    const qs = (s, r=document)=>r.querySelector(s);
    const qsa = (s, r=document)=>Array.from(r.querySelectorAll(s));
    const safe = (s)=> (s==null ? '' : String(s));
    const escape = (s)=> safe(s).replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'''}[c]));
    const fmtDate = (s)=> s && s.toUpperCase()!=='N/A' ? s : 'N/A';

    async function send(payload){
      try{
        const res = await fetch(feedbackEndpoint, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) });
        return res.ok;
      }catch{return false;}
    }
    function openModal(id){ const m=qs(id); if(m){ m.classList.remove('hidden'); m.setAttribute('aria-hidden','false'); } }
    function closeModal(el){ const m=el.closest('.modal'); if(m){ m.classList.add('hidden'); m.setAttribute('aria-hidden','true'); } }

    async function renderStatus(){
      const pill = qs('#health-pill'), last = qs('#last-updated'), total = qs('#total-listings');
      try{
        const h = await (await fetch('health.json'+bust(), {cache:'no-store'})).json();
        pill.textContent = h.ok ? 'Health: OK' : 'Health: Not OK';
        pill.className = 'pill ' + (h.ok ? 'ok' : 'bad');
        last.textContent = 'Last updated: ' + (h.lastUpdated ? new Date(h.lastUpdated).toLocaleString() : '—');
        total.textContent = 'Listings: ' + (typeof h.totalListings==='number' ? h.totalListings : '—');
      }catch{
        pill.textContent='Health: Unknown'; pill.className='pill';
        last.textContent='Last updated: —'; total.textContent='Listings: —';
      }
    }

    function cardTemplate(job){
      const trusted = job.flags && job.flags.trusted;
      const badge = trusted ? '<span class="chip ok">✓ trusted</span>' : '';
      const daysLeft = (job.daysLeft ?? '—');
      return `
        <article class="card" data-id="${escape(job.id||'')}">
          <header class="card-head">
            <h3 class="title">${escape(job.title||'No Title')}</h3>
            ${badge}
          </header>
          <div class="card-body">
            <div class="rowline"><span class="muted">Organization</span><span>${escape(job.organization||'N/A')}</span></div>
            <div class="rowline"><span class="muted">Qualification</span><span>${escape(job.qualificationLevel||'N/A')}</span></div>
            <div class="rowline"><span class="muted">Domicile</span><span>${escape(job.domicile||'All India')}</span></div>
            <div class="rowline"><span class="muted">Last date</span><span>${escape(fmtDate(job.deadline))} <span class="muted">(${daysLeft} days)</span></span></div>
          </div>
          <footer class="card-actions">
            <a class="btn primary" href="${escape(job.applyLink||'#')}" target="_blank" rel="noopener">Apply</a>
            <a class="btn ghost" href="${escape(job.detailLink || job.applyLink || '#')}" target="_blank" rel="noopener">Details</a>
            <span class="spacer"></span>
            <button class="btn ok" data-act="right">Right</button>
            <button class="btn warn" data-act="wrong">Wrong</button>
            <button class="btn" data-act="applied">Applied</button>
            <button class="btn" data-act="not_interested">Not interested</button>
            <button class="btn danger" data-act="report">Report</button>
          </footer>
        </article>
      `;
    }

    async function render(){
      const root = qs('#jobs-root'), appRoot = qs('#applied-root'), otherRoot = qs('#other-root');
      root.innerHTML = appRoot.innerHTML = otherRoot.innerHTML = '';

      let data;
      try{
        const res = await fetch('data.json'+bust(), {cache:'no-store'});
        data = await res.json();
      }catch(e){
        root.innerHTML = `<div class="empty">Could not load data.json</div>`;
        return;
      }
      const list = Array.isArray(data.jobListings) ? data.jobListings : [];
      const sections = data.sections || {};
      qs('#total-listings').textContent = 'Listings: ' + list.length;

      const idsApplied = new Set(sections.applied || []);
      const idsOther = new Set(sections.other || []);

      if (list.length === 0) {
        root.innerHTML = `<div class="empty">No active job listings found.</div>`;
        return;
      }

      const fragPrimary = document.createDocumentFragment();
      const fragApplied = document.createDocumentFragment();
      const fragOther = document.createDocumentFragment();

      for (const job of list){
        const html = cardTemplate(job);
        const wrap = document.createElement('div');
        wrap.innerHTML = html;
        const card = wrap.firstElementChild;

        card.addEventListener('click', async (e)=>{
          const btn = e.target.closest('[data-act]'); if(!btn) return;
          const act = btn.getAttribute('data-act');
          const id = card.getAttribute('data-id');
          const title = card.querySelector('.title')?.textContent.trim().slice(0,240) || '';
          const url = card.querySelector('a.primary')?.href || '';
          let payload;
          if(act==='right' || act==='wrong'){
            payload = { type:'vote', vote:act, jobId:id, title, url, clientTs:new Date().toISOString() };
          }else if(act==='report'){
            payload = { type:'report', jobId:id, title, url, note:'user report', clientTs:new Date().toISOString() };
          }else if(act==='applied' || act==='not_interested'){
            payload = { type:'state', payload:{ jobId:id, action:act, ts:new Date().toISOString() } };
          }
          if(payload){ const ok=await send(payload); if(!ok) alert('Network issue, please retry.'); }
        });

        if (idsApplied.has(job.id)) fragApplied.appendChild(card);
        else if (idsOther.has(job.id)) fragOther.appendChild(card);
        else fragPrimary.appendChild(card);
      }

      root.appendChild(fragPrimary);
      appRoot.appendChild(fragApplied);
      otherRoot.appendChild(fragOther);
    }

    // Modals & forms
    document.addEventListener('click', (e)=>{
      if(e.target && e.target.matches('#btn-missing')) openModal('#missing-modal');
      if(e.target && e.target.hasAttribute('data-close')) closeModal(e.target);
    });

    qs('#reportForm').addEventListener('submit', async (e)=>{
      e.preventDefault();
      const id = qs('#reportListingId').value.trim();
      const reason = qs('#reportReason').value.trim();
      const url = qs('#reportEvidenceUrl').value.trim();
      const note = qs('#reportNote').value.trim();
      const ok = await send({ type:'report', jobId:id, title:reason, url, note, clientTs:new Date().toISOString() });
      if(!ok) return alert('Failed to submit.');
      closeModal(e.target);
      e.target.reset();
      alert('Reported.');
    });

    qs('#missingForm').addEventListener('submit', async (e)=>{
      e.preventDefault();
      const title = qs('#missingTitle').value.trim();
      const url = qs('#missingUrl').value.trim();
      const lastDate = qs('#missingLastDate').value.trim();
      const note = qs('#missingNote').value.trim();
      if(!title || !url) return alert('Post name and official link are required.');
      const ok = await send({ type:'missing', title, url, lastDate, note, clientTs:new Date().toISOString() });
      if(!ok) return alert('Failed to submit.');
      closeModal(e.target);
      e.target.reset();
      alert('Saved. It will appear after the next refresh.');
    });

    // Init
    (async function init(){
      await renderStatus();
      await render();
    })();
  </script>
</body>
</html>
