<script>
(function(){
  var ENDPOINT = "https://vacancy.animeshkumar97.workers.dev";
  var bust = ()=>"?t="+Date.now();

  function qs(s, r){ return (r||document).querySelector(s); }
  function qsa(s, r){ return Array.from((r||document).querySelectorAll(s)); }
  function esc(s){ return (s==null? "": String(s)).replace(/[&<>\"']/g, c=>({"&":"&amp;","<":"&lt;","&gt;":"&gt;","\"":"&quot;","'":""}[c])); }
  function fmtDate(s){ return s && s.toUpperCase()!=="N/A" ? s : "N/A"; }
  function toast(msg){ var t=qs("#toast"); if(!t) return alert(msg); t.textContent=msg; t.style.opacity="1"; clearTimeout(t._h); t._h=setTimeout(()=>t.style.opacity="0",1600); }

  // local stores + guards
  const lsOK = (function(){ try{ localStorage.setItem("__t","1"); localStorage.removeItem("__t"); return true; }catch{ return false; }})();
  function L(k,d){ if(!lsOK) return d; try{ return JSON.parse(localStorage.getItem(k)||JSON.stringify(d)); }catch{ return d; } }
  function S(k,v){ if(!lsOK) return; try{ localStorage.setItem(k, JSON.stringify(v)); }catch{} }

  var USER_STATE=L("vac_user_state",{}), USER_VOTES=L("vac_user_votes",{}), EXAM_DONE=L("vac_exam_done",{}), OUTBOX=L("vac_outbox",[]);

  function saveAll(){ S("vac_user_state",USER_STATE); S("vac_user_votes",USER_VOTES); S("vac_exam_done",EXAM_DONE); S("vac_outbox",OUTBOX); }
  function purgeExam(){ let now=Date.now(), ch=false; Object.keys(EXAM_DONE).forEach(id=>{ if(now-Date.parse(EXAM_DONE[id])>172800000){ delete EXAM_DONE[id]; ch=true; } }); if(ch) S("vac_exam_done",EXAM_DONE); }
  async function flushOutbox(){
    if(!OUTBOX.length) return;
    let rest=[];
    for(const p of OUTBOX){
      try{ const r=await fetch(ENDPOINT,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(p)}); if(!r.ok) rest.push(p); }
      catch{ rest.push(p); }
    }
    OUTBOX=rest; S("vac_outbox",OUTBOX);
  }
  function enqueue(payload){ OUTBOX.push(payload); S("vac_outbox",OUTBOX); setTimeout(flushOutbox, 1500); }

  // Tabs
  function activate(tab){
    qsa(".tab").forEach(t=>t.classList.toggle("active", t.dataset.tab===tab));
    qsa(".panel").forEach(p=>p.classList.toggle("active", p.id==="panel-"+tab));
  }
  qs("#tabs").addEventListener("click", (e)=>{
    const btn=e.target.closest(".tab"); if(!btn) return;
    activate(btn.dataset.tab);
  });

  // Render single-flight scheduler
  let RQ = { pending:false, scheduled:false };
  async function runRender(){
    if(RQ.pending){ RQ.scheduled=true; return; }
    RQ.pending=true; try{ await renderReal(); } catch(e){ console.error(e); toast("Display error, retrying…"); }
    RQ.pending=false;
    if(RQ.scheduled){ RQ.scheduled=false; requestAnimationFrame(runRender); }
  }
  function requestRender(){ requestAnimationFrame(runRender); }

  async function renderStatus(){
    const pill=qs("#health-pill"), last=qs("#last-updated"), total=qs("#total-listings");
    try{
      const h=await (await fetch("health.json"+bust(),{cache:"no-store"})).json();
      pill.textContent=h.ok?"Health: OK":"Health: Not OK"; pill.className="pill "+(h.ok?"ok":"bad");
      last.textContent="Last updated: "+(h.lastUpdated?new Date(h.lastUpdated).toLocaleString():"—");
      total.textContent="Listings: "+(typeof h.totalListings==="number"?h.totalListings:"—");
    }catch{ pill.textContent="Health: Unknown"; pill.className="pill"; last.textContent="Last updated: —"; total.textContent="Listings: —"; }
  }

  function postsValue(j){ return j.numberOfPosts ?? j.posts ?? j.vacancies ?? "N/A"; }

  function cardHTML(j, applied=false){
    const trusted=j.flags&&j.flags.trusted, chip=trusted?'<span class="chip trust big">trusted</span>':"";
    const d=j.daysLeft!=null?j.daysLeft:"—";
    const det=esc(j.detailLink||j.applyLink||"#");
    const srcRibbon=(j.source||"").toLowerCase()==="official" ? '<span class="chip big" title="Official source">Official</span>' : '<span class="chip big" title="From aggregator">Agg</span>';
    const lid=j.id||"", isExamDone=!!EXAM_DONE[lid]; const showVote=!(applied||isExamDone);
    return '<article class="ua-card'+(applied?' applied':'')+'" data-id="'+esc(lid)+'">'+
      '<div class="ua-head"><h3 class="ua-title">'+esc(j.title||"No Title")+'</h3><div class="ua-chips">'+srcRibbon+chip+'</div></div>'+
      '<div class="ua-body">'+
        '<div class="ua-row"><span class="muted">Number of posts</span><span>'+esc(postsValue(j))+'</span></div>'+
        '<div class="ua-row"><span class="muted">Qualification</span><span>'+esc(j.qualificationLevel||"N/A")+'</span></div>'+
        '<div class="ua-row"><span class="muted">Domicile</span><span>'+esc(j.domicile||"All India")+'</span></div>'+
        '<div class="ua-row"><span class="muted">Last date</span><span>'+esc(fmtDate(j.deadline))+' <span class="muted">('+d+' days)</span></span></div>'+
      '</div>'+
      '<div class="ua-bottombar"><a class="btn primary" href="'+det+'" target="_blank" rel="noopener">Details</a><span class="spacer"></span><button class="btn danger" data-act="report">Report</button></div>'+
      '<footer class="ua-actions2">'+
        (isExamDone? '<div class="exam-row"><span class="exam-badge">Exam over</span><button class="btn ghost tiny" data-act="exam_clear">Clear</button></div>' :
          '<div class="row2">'+
            (showVote? '<div class="btn-pair"><button class="btn ok" data-act="right">Right</button><button class="btn warn" data-act="wrong">Wrong</button></div>' : '<span></span>')+
            '<span class="spacer"></span>'+
            (applied? '<button class="btn applied-pill" data-act="exam_done">Exam done</button>' :
              '<div class="btn-pair"><button class="btn applied-pill" data-act="applied">Applied</button><button class="btn neutral-pill" data-act="not_interested">Not interested</button></div>')+
          '</div>')+
      '</footer></article>';
  }

  function sortByDeadline(list){
    const parse=(s)=>{ if(!s||s.toUpperCase()==="N/A") return null; const a=s.replaceAll("-","/").split("/"); if(a.length!==3) return null; const ms=Date.UTC(+a[2],+a[1]-1,+a[0]); return isNaN(ms)?null:ms; };
    return list.slice().sort((a,b)=>{ const da=parse(a.deadline), db=parse(b.deadline); if(da===null && db===null) return (a.title||"").localeCompare(b.title||""); if(da===null) return 1; if(db===null) return -1; return da-db; });
  }

  async function renderReal(){
    const rootOpen=qs("#open-root"), rootApp=qs("#applied-root"), rootOther=qs("#other-root");
    rootOpen.innerHTML=rootApp.innerHTML=rootOther.innerHTML="";
    purgeExam(); await flushOutbox();

    const data=await (await fetch("data.json"+bust(),{cache:"no-store"})).json();
    const list=sortByDeadline(Array.isArray(data.jobListings)? data.jobListings:[]);
    const sections=data.sections||{};
    qs("#total-listings").textContent="Listings: "+list.length;

    let idsApplied=new Set(sections.applied||[]), idsOther=new Set(sections.other||[]);
    Object.entries(USER_STATE||{}).forEach(([jid, st])=>{
      const a=(st||{}).action;
      if(a==="applied"){ idsApplied.add(jid); idsOther.delete(jid); }
      if(a==="not_interested"){ idsOther.add(jid); idsApplied.delete(jid); }
      if(a==="undo"){ idsApplied.delete(jid); idsOther.delete(jid); }
    });

    const fOpen=document.createDocumentFragment(), fApp=document.createDocumentFragment(), fOther=document.createDocumentFragment();
    if(list.length===0){ rootOpen.innerHTML='<div class="empty">No active job listings found.</div>'; return; }

    for(const job of list){
      const isApplied=idsApplied.has(job.id);
      const wrap=document.createElement("div"); wrap.innerHTML=cardHTML(job, isApplied); const card=wrap.firstElementChild;

      card.addEventListener("click", (e)=>{
        try{
          const b=e.target.closest("[data-act]"); if(!b) return;
          if(b.classList.contains("disabled")) return;
          const act=b.getAttribute("data-act"), id=card.getAttribute("data-id"),
                title=(card.querySelector(".ua-title")?.textContent||"").trim().slice(0,240),
                detailsUrl=(card.querySelector("a.primary")?.href||"");
          // Persist first, render later
          if(act==="report"){
            qs("#reportListingId").value=id; const m=qs("#report-modal"); m.classList.remove("hidden"); m.classList.add("flex"); m.setAttribute("aria-hidden","false"); return;
          }
          if(act==="right"){ USER_VOTES[id]={vote:"right", ts:new Date().toISOString()}; S("vac_user_votes",USER_VOTES); OUTBOX.push({type:"vote", vote:"right", jobId:id, title, url:detailsUrl, ts:new Date().toISOString()}); S("vac_outbox",OUTBOX); requestRender(); return; }
          if(act==="wrong"){ USER_VOTES[id]={vote:"wrong", ts:new Date().toISOString()}; S("vac_user_votes",USER_VOTES); OUTBOX.push({type:"vote", vote:"wrong", jobId:id, title, url:detailsUrl, ts:new Date().toISOString()}); S("vac_outbox",OUTBOX); requestRender(); return; }
          if(act==="applied"){ USER_STATE[id]={action:"applied", ts:new Date().toISOString()}; S("vac_user_state",USER_STATE); OUTBOX.push({type:"state", payload:{jobId:id, action:"applied", ts:new Date().toISOString()}}); S("vac_outbox",OUTBOX); requestRender(); return; }
          if(act==="not_interested"){ USER_STATE[id]={action:"not_interested", ts:new Date().toISOString()}; S("vac_user_state",USER_STATE); OUTBOX.push({type:"state", payload:{jobId:id, action:"not_interested", ts:new Date().toISOString()}}); S("vac_outbox",OUTBOX); requestRender(); return; }
          if(act==="exam_done"){ EXAM_DONE[id]=new Date().toISOString(); S("vac_exam_done",EXAM_DONE); requestRender(); return; }
          if(act==="exam_clear"){ delete EXAM_DONE[id]; S("vac_exam_done",EXAM_DONE); requestRender(); return; }
        }catch(err){
          console.error("click-handler", err);
          toast("Action saved locally; refreshing view…");
          requestRender();
        }
      });

      if(isApplied) fApp.appendChild(card);
      else if(idsOther.has(job.id)) fOther.appendChild(card);
      else fOpen.appendChild(card);
    }

    rootOpen.appendChild(fOpen);
    rootApp.appendChild(fApp);
    rootOther.appendChild(fOther);
  }

  // Modals + forms
  function openModal(id){ const m=qs(id); if(m){ m.classList.remove("hidden"); m.classList.add('flex'); m.setAttribute("aria-hidden","false"); } }
  function closeModal(el){ const m=el.closest(".modal"); if(m){ m.classList.add("hidden"); m.classList.remove('flex'); m.setAttribute("aria-hidden","true"); } }
  document.addEventListener("click", (e)=>{ if(e.target && e.target.hasAttribute("data-close")) closeModal(e.target); });

  document.addEventListener("DOMContentLoaded", async ()=>{
    await renderStatus(); requestRender();

    qs("#btn-missing")?.addEventListener("click", ()=>openModal("#missing-modal"));

    qs("#reportForm")?.addEventListener("submit", (e)=>{
      e.preventDefault();
      try{
        const id=qs("#reportListingId").value.trim();
        const rc=qs("#reportReason").value||"";
        const ev=qs("#reportEvidenceUrl").value.trim();
        const posts=qs("#reportPosts").value.trim();
        const note=qs("#reportNote").value.trim();
        if(!id || !rc) return toast("Please select a reason.");
        OUTBOX.push({ type:"report", jobId:id, reasonCode:rc, evidenceUrl:ev, posts:posts||null, note, ts:new Date().toISOString() });
        S("vac_outbox",OUTBOX);
        closeModal(e.target); e.target.reset(); toast("Reported.");
        requestRender();
      }catch(err){ console.error(err); toast("Saved, displaying soon…"); requestRender(); }
    });

    const SUBLOCK=new Set();
    qs("#missingForm")?.addEventListener("submit", (e)=>{
      e.preventDefault();
      try{
        const title=qs("#missingTitle").value.trim();
        const url=qs("#missingUrl").value.trim();
        const site=qs("#missingSite").value.trim();
        const last=qs("#missingLastDate").value.trim();
        const posts=qs("#missingPosts").value.trim();
        const note=qs("#missingNote").value.trim();
        if(!title||!url) return toast("Post name and notification link are required.");
        const key=url.replace(/[?#].*$/,"").toLowerCase();
        if(SUBLOCK.has(key)) return toast("Already submitted.");
        SUBLOCK.add(key);
        OUTBOX.push({ type:"missing", title, url, officialSite:site, lastDate:last, posts:posts||null, note, ts:new Date().toISOString() });
        S("vac_outbox",OUTBOX);
        closeModal(e.target); e.target.reset(); toast("Saved. Will appear after refresh.");
        requestRender();
      }catch(err){ console.error(err); toast("Saved, displaying soon…"); requestRender(); }
    });
  });
})();
</script>
