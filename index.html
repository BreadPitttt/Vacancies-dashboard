<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>General Vacancy Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta http-equiv="Cache-Control" content="no-store" />
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Helvetica, Arial, sans-serif; margin: 0; background: #0b1220; color: #eef2ff; }
    header { padding: 16px 20px; background: #0f172a; position: sticky; top: 0; z-index: 2; }
    h1 { margin: 0; font-size: 20px; }
    #stats { opacity: 0.8; font-size: 13px; margin-top: 6px; }
    main { padding: 16px 20px; max-width: 960px; margin: auto; }
    .section-title { margin: 18px 0 8px; font-size: 16px; opacity: 0.9; }
    .card { background: #161b2d; margin-bottom: 12px; border-radius: 8px; padding: 16px; }
    .card-title { font-weight: bold; font-size: 15px; color: #62dafb; }
    .meta div { font-size: 13px; margin-top: 4px; }
    .actions { margin-top: 12px; }
    .btn, a.btn { font-size: 12px; padding: 6px 10px; border-radius: 4px; border: none; cursor: pointer; user-select: none; margin-right: 6px; }
    a.btn { text-decoration: none; color: #fff; }
    .btn:hover, a.btn:hover { opacity: 0.85; }
    .btn-apply { background: #3b82f6; }
    .btn-right { background: #22c55e; color: white; }
    .btn-wrong { background: #ef4444; color: white; }
    .btn-report { background: #f97316; color: white; }
    .btn-applied { background: #0ea5e9; color: white; }
    .btn-noti { background: #64748b; color: white; }
    .badge { display:inline-block; font-size:11px; padding:2px 6px; border-radius:4px; margin-left:6px; background:#1f2937; color:#a7f3d0; }
    .trusted { color:#22c55e; }
  </style>
</head>
<body>
  <header>
    <h1>General Vacancy Dashboard</h1>
    <div id="stats">Loading...</div>
  </header>
  <main id="app"></main>

  <script>
    const API_ENDPOINT = 'https://vacancy.animeshkumar97.workers.dev/v1/submit';
    const STORAGE_KEY = 'vd_vote_queue';

    function h(tag, cls, html){
      const e=document.createElement(tag);
      if(cls) e.className=cls;
      if(html!==undefined) e.innerHTML=html;
      return e;
    }
    function sectionWrap(title){
      const wrap=h('div','section');
      wrap.appendChild(h('div','section-title',title));
      const cont=h('div','cards'); wrap.appendChild(cont);
      return {wrap, cont};
    }
    function fmtDate(s){ return s && s.toUpperCase()!=='N/A' ? s : 'N/A'; }

    function getCardData(card){
      return {
        id: card.getAttribute('data-id') || '',
        title: (card.querySelector('.card-title')?.textContent || '').trim().slice(0,240),
        url: (card.querySelector('a.btn-apply')?.href || '').trim()
      };
    }

    async function send(payload){
      try{
        const res = await fetch(API_ENDPOINT, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) });
        return res.ok;
      }catch{return false;}
    }
    function enqueue(payload){
      try{
        const q = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
        q.push({...payload, queuedAt:new Date().toISOString()});
        localStorage.setItem(STORAGE_KEY, JSON.stringify(q).slice(0, 200000));
      }catch{}
    }
    async function flushQueue(){
      try{
        const q = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
        if(q.length===0) return;
        const item=q.shift();
        const ok=await send(item);
        if(ok){ localStorage.setItem(STORAGE_KEY, JSON.stringify(q)); if(q.length) setTimeout(flushQueue, 400); }
        else{ q.unshift(item); localStorage.setItem(STORAGE_KEY, JSON.stringify(q)); }
      }catch{}
    }

    async function submitVote(card, kind){
      const c = getCardData(card);
      if(!c.id) return alert('Missing job id.');
      let payload;
      if(kind==='right' || kind==='wrong'){
        payload = { type:'vote', vote:kind, jobId:c.id, title:c.title, url:c.url, clientTs:new Date().toISOString() };
      }else if(kind==='report'){
        payload = { type:'report', jobId:c.id, title:c.title, url:c.url, note:'user report', clientTs:new Date().toISOString() };
      }else if(kind==='applied' || kind==='not_interested'){
        payload = { type:'state', payload:{ jobId:c.id, action:kind, ts:new Date().toISOString() } };
      }
      const ok = await send(payload);
      if(!ok){ enqueue(payload); setTimeout(flushQueue, 400); }
    }

    function cardHTML(job, sections){
      const trusted = job.flags && job.flags.trusted;
      const applied = job.flags && job.flags.applied;
      return `
        <div class="card-title">${job.title || 'N/A'} ${trusted?'<span class="badge trusted">âœ“ trusted</span>':''}</div>
        <div class="meta">
          <div>Organization: ${job.organization || 'N/A'}</div>
          <div>Qualification: ${job.qualificationLevel || 'N/A'}</div>
          <div>Domicile: ${job.domicile || 'All India'}</div>
          <div>Last date: ${fmtDate(job.deadline)}</div>
        </div>
        <div class="actions">
          <a href="${job.applyLink || '#'}" class="btn btn-apply" target="_blank" rel="noopener noreferrer">Apply Here</a>
          <button data-act="report" class="btn btn-report">Report</button>
          <button data-act="right" class="btn btn-right">Right</button>
          <button data-act="wrong" class="btn btn-wrong">Wrong</button>
          <button data-act="applied" class="btn btn-applied">Applied</button>
          <button data-act="not_interested" class="btn btn-noti">Not interested</button>
        </div>
      `;
    }

    async function render(){
      const res = await fetch('data.json', {cache:'no-store'});
      const data = await res.json();
      const list = data.jobListings || [];
      const sections = data.sections || {};
      const app = document.getElementById('app'); app.innerHTML = '';
      document.getElementById('stats').textContent = `Listings: ${list.length}`;

      const secApplied = sectionWrap('Applied (always visible)');
      const secPrimary = sectionWrap('Open vacancies');
      const secOther = sectionWrap('Other (past date or not interested)');

      const idsApplied = new Set(sections.applied || []);
      const idsOther = new Set(sections.other || []);

      for(const job of list){
        const card = h('div','card'); card.classList.add('job-card'); card.setAttribute('data-id', job.id || '');
        card.innerHTML = cardHTML(job, sections);
        card.addEventListener('click', e=>{
          const btn = e.target.closest('[data-act]'); if(!btn) return;
          submitVote(card, btn.getAttribute('data-act'));
        });
        if(idsApplied.has(job.id)) secApplied.cont.appendChild(card);
        else if(idsOther.has(job.id)) secOther.cont.appendChild(card);
        else secPrimary.cont.appendChild(card);
      }
      app.appendChild(secPrimary.wrap);
      app.appendChild(secApplied.wrap);
      app.appendChild(secOther.wrap);
    }
    render();
    window.addEventListener('load', flushQueue);
  </script>
</body>
</html>
